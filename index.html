<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CO‚ÇÇ Widget Logic - MultiversX & Solana</title>
  <style>
    body { margin:0; padding:0; background:transparent; font-family:'Segoe UI',sans-serif; color:white; }
    .widget {
      background: rgba(24,24,32,0.9);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      padding: 30px 20px;
      max-width: 420px;
      margin: 0 auto;
      text-align: center;
      box-shadow: 0 0 30px rgba(0,0,0,0.4);
    }
    .widget h3 { margin-bottom:12px; }
    .widget input {
      width:100%; padding:12px 16px; margin-bottom:20px;
      border:none; border-radius:12px; background:#12121c; color:white; font-size:1em;
    }
    .submit-btn, .add-btn, .ai-btn {
      width:100%; padding:12px; margin-bottom:12px;
      border:none; border-radius:14px; font-weight:bold; font-size:1em;
      display:flex; align-items:center; justify-content:center; gap:8px;
      cursor:pointer;
    }
    .submit-btn { background:linear-gradient(to right,#e664e8,#00ffe7); color:black; }
    .add-btn    { background:linear-gradient(to right,#9d50bb,#6e48aa); color:white; }
    .ai-btn     { background:linear-gradient(to right,#e664e8,#00ffe7); color:black; }
    .info-cards { display:flex; gap:12px; justify-content:center; margin-bottom:30px; }
    .card {
      background:linear-gradient(to bottom,#30243e,#1d1c28);
      border-radius:16px; padding:12px 8px; flex:1; max-width:100px; text-align:center;
    }
    .card-icon { font-size:22px; margin-bottom:6px; }
    .card-title { font-size:0.85em; color:#ccc; margin-bottom:4px; }
    .card-value { font-size:1em; font-weight:bold; }
    .total-label { font-size:0.9em; color:#aaa; margin-bottom:6px; }
    .total-value { font-size:1.8em; font-weight:bold; margin-bottom:12px; }
    .tx-count   { font-size:0.9em; color:#bbb; margin-bottom:24px; }
    .note       { font-size:0.75em; color:#999; margin-bottom:16px; }
    @media(max-width:600px){
      .widget { padding:16px 12px; }
      .widget h3 { font-size:1.2em; margin-bottom:8px; }
      .widget input { padding:10px 14px; margin-bottom:12px; font-size:0.9em; }
      .submit-btn, .add-btn, .ai-btn { padding:10px; font-size:0.9em; margin-bottom:8px; }
      .info-cards { gap:6px; margin-bottom:16px; }
      .card { padding:8px 4px; max-width:80px; }
      .card-title { font-size:0.75em; }
      .card-value { font-size:0.9em; }
      .total-label { font-size:0.8em; margin-bottom:4px; }
      .total-value { font-size:1.4em; margin-bottom:8px; }
      .tx-count { margin-bottom:12px; }
      .note:last-of-type { display:none; }
    }
  </style>
</head>
<body>
  <div class="widget">
    <h3>Web3 Project Address</h3>
    <input id="contractInput" placeholder="0x‚Ä¶, erd1‚Ä¶, or TOKEN-ID" />
    <button class="submit-btn" onclick="analyzeContract()">üîç Submit</button>
    <div id="loading" style="display:none; margin:10px 0;">üîÑ Realm¬≤ Scanning...</div>

    <div class="info-cards">
      <div class="card">
        <div class="card-icon">üîó</div>
        <div class="card-title">Blockchain</div>
        <div id="valBlockchain" class="card-value" style="color:#ff7ed4;">? g</div>
      </div>
      <div class="card">
        <div class="card-icon">üíª</div>
        <div class="card-title">Website</div>
        <div id="valWebsite" class="card-value" style="color:#6cf;">? g</div>
      </div>
      <div class="card">
        <div class="card-icon">üì±</div>
        <div class="card-title">Social media</div>
        <div id="valSocial" class="card-value" style="color:#62fbbf;">? g</div>
      </div>
    </div>

    <div class="total-label">Total CO‚ÇÇ Emissions</div>
    <div id="totalCO2" class="total-value">? g</div>
    <div id="txCountDisplay" class="tx-count"></div>

    <button class="add-btn">üîó Add to website</button>
    <button class="ai-btn">ü§ñ AI Analysis</button>
    <div class="note">This estimation only takes into account the smart contract‚Äôs transactions</div>
  </div>

  <script>
    // R√©cup√®re le nombre de transactions pour un Token-ID via GraphQL
    async function fetchTokenTxCount(tokenId) {
      const query = {
        query: `
          query($id:String!) {
            token(identifier:$id) {
              transactionsCount
            }
          }
        `,
        variables: { id: tokenId }
      };
      try {
        const res  = await fetch("https://graphql-api.multiversx.com/graphql", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(query)
        });
        const json = await res.json();
        return json.data?.token?.transactionsCount || 0;
      } catch (err) {
        console.error("GraphQL token fetch error", err);
        return 0;
      }
    }

    // R√©cup√®re le nombre de transactions pour une adresse (avec txCount)
    async function fetchAccountTxCount(addr) {
      try {
        const res  = await fetch(`https://api.multiversx.com/accounts/${addr}?withTxCount=true`);
        const json = await res.json();
        return json.data?.txCount || 0;
      } catch (e) {
        console.error("Account fetch error", e);
        return 0;
      }
    }

    // Fonction principale
    async function analyzeContract() {
      const raw = document.getElementById("contractInput").value
        .replace(/[^\x21-\x7E]/g,"")  // enl√®ve caract√®res invisibles
        .trim();

      const isAddress = /^erd1[0-9a-z]{58}$/i.test(raw);
      const isTokenId = /^[A-Z0-9]+-[a-z0-9]+$/i.test(raw);

      if (!isAddress && !isTokenId) {
        alert("Invalid address or token ID format.");
        return;
      }

      document.getElementById("loading").style.display = "block";
      ["valBlockchain","valWebsite","valSocial"].forEach(id => {
        document.getElementById(id).innerText = "...";
      });
      document.getElementById("totalCO2").innerText = "...";
      document.getElementById("txCountDisplay").innerText = "";

      // R√©cup√©ration du txCount
      const txCount = isTokenId
        ? await fetchTokenTxCount(raw)
        : await fetchAccountTxCount(raw);

      const co2PerTx = 0.00032;  // grammes par transaction
      const grams = Math.round(txCount * co2PerTx);

      // Affichage des r√©sultats
      ["valBlockchain","valWebsite","valSocial"].forEach(id => {
        document.getElementById(id).innerText = `${grams} g`;
      });
      document.getElementById("totalCO2").innerText       = `${grams} g`;
      document.getElementById("txCountDisplay").innerText = `(based on ${txCount.toLocaleString()} tx)`;
      document.getElementById("loading").style.display    = "none";
    }
  </script>
</body>
</html>
